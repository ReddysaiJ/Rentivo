<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-pattern="Rentivo - Update Booking">Update Booking</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="card mx-auto mt-4" style="max-width: 600px;">
            <div class="card-body">
                <h2 class="text-center text-primary mb-4">Update Booking</h2>
                <form id="updateBookingForm" method="POST" th:action="@{/booking/update/{id}(id=${carBooking.id})}" th:if="${carBooking != null}">
                    <input type="hidden" name="id" th:value="${carBooking.id}"/>
                    <input type="hidden" name="customer.id" th:value="${carBooking.customer?.id}"/>
                    <input type="hidden" name="amountDue" th:value="${carBooking.amountDue}"/>
                    <input type="hidden" name="cancelableOrUpdatable" th:value="${carBooking.cancelableOrUpdatable}"/>
                    <input type="hidden" name="paymentStatus" th:value="${carBooking.paymentStatus}"/>
                    <div class="mb-3">
                        <label for="car" class="form-label">Car</label>
                        <select name="car.id" id="car" class="form-select" required disabled>
                            <option th:value="${carBooking.car?.id}"
                                    th:data-price="${carBooking.car?.price}"
                                    th:text="${carBooking.car?.model} + ' - Price: ₹' + ${carBooking.car?.price} + '/day'"
                                    selected>
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="form-control" required
                               th:value="${carBooking.startDate}"
                               th:attr="min=${today}"/>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="form-control" required
                               th:value="${carBooking.endDate}"/>
                    </div>
                    <div class="alert alert-primary mb-3" role="alert">
                        <p class="mb-0"><strong>Total Amount:</strong> ₹<span id="totalAmount" th:text="${carBooking.amountDue != null ? carBooking.amountDue : '0.00'}">0.00</span></p>
                    </div>
                    <div class="alert alert-danger mb-3" id="errorMessage" role="alert" style="display: none;"></div>
                    <div class="d-flex justify-content-between">
                        <a th:href="@{/booking/myBookings}" class="btn btn-outline-secondary">Back to My Bookings</a>
                        <button type="submit" class="btn btn-success">Update Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const totalAmountElement = document.getElementById('totalAmount');
            const errorMessageElement = document.getElementById('errorMessage');
            const carSelect = document.getElementById('car');
            const carPrice = carSelect ? parseFloat(carSelect.options[carSelect.selectedIndex].getAttribute('data-price')) : 0;
            const today = new Date().toISOString().split('T')[0];

            if (startDateInput) startDateInput.setAttribute('min', today);

            function setMinEndDate() {
                if (startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setDate(startDate.getDate() + 1);
                    endDateInput.setAttribute('min', startDate.toISOString().split('T')[0]);
                    if (endDateInput.value && new Date(endDateInput.value) <= new Date(startDateInput.value)) {
                        endDateInput.value = '';
                        totalAmountElement.textContent = '0.00';
                    }
                }
            }

            function updateAmount() {
                if (startDateInput.value && endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    const dayDiff = (endDate - startDate) / (1000 * 3600 * 24);
                    totalAmountElement.textContent = dayDiff > 0 ? (dayDiff * carPrice).toFixed(2) : '0.00';
                } else {
                    totalAmountElement.textContent = '0.00';
                }
            }

            if (startDateInput) startDateInput.addEventListener('change', function () {
                setMinEndDate();
                updateAmount();
            });

            if (endDateInput) endDateInput.addEventListener('change', updateAmount);

            document.getElementById('updateBookingForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const form = e.target;
                const carId = carSelect.value;
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const pathArray = window.location.pathname.split('/');
                const bookingId = pathArray[pathArray.length - 1];

                if (startDate && endDate && new Date(endDate) <= new Date(startDate)) {
                    errorMessageElement.textContent = "End date must be after the start date.";
                    errorMessageElement.style.display = 'block';
                    return;
                }

                fetch(`/booking/checkCarAvailability?carId=${carId}&startDate=${startDate}&endDate=${endDate}&excludeBookingId=${bookingId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.available) {
                            form.submit();
                        } else {
                            errorMessageElement.textContent = "Car is not available for the selected dates.";
                            errorMessageElement.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        errorMessageElement.textContent = "An error occurred while checking availability.";
                        errorMessageElement.style.display = 'block';
                    });
            });

            setMinEndDate();
            updateAmount();
        });
    </script>
</div>
</body>
</html>