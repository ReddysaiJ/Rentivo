<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Custom CSS for minimal overrides -->
    <style>
        .profile-image {
            width: 150px;
            height: 150px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview img {
            max-width: 100px;
            max-height: 100px;
            display: none;
            border: 1px solid #ccc;
        }

        .status {
            font-weight: bold;
            padding: 8px 12px;
        }
    </style>

    <!-- Profile Header -->
    <h2 class="text-center text-primary mb-4">User Profile</h2>

    <!-- Profile Container -->
    <div class="card mx-auto mb-4" style="max-width: 900px;">
        <div class="card-body d-flex flex-column flex-md-row align-items-center align-items-md-start gap-4">
            <div class="profile-image rounded-circle">
                <img id="profile-photo" th:src="${user.photo}" alt="Profile Picture"
                     onerror="this.src='/images/users/default-profile.jpg'" class="rounded-circle">
            </div>
            <div class="flex-grow-1">
                <p class="mb-2"><strong>Username:</strong> <span th:text="${user.username} ?: 'N/A'"></span></p>
                <p class="mb-2"><strong>Email:</strong> <span th:text="${user.email} ?: 'N/A'"></span></p>
                <p class="mb-2"><strong>Phone:</strong> <span th:text="${user.phno} ?: 'N/A'"></span></p>
                <p class="mb-2"><strong>Role:</strong>
                    <span th:text="${(user.role.name() == 'ROLE_USER') ? 'USER' : (user.role.name() == 'ROLE_ADMIN' ? 'ADMIN' : 'N/A')}"></span></p>
                <p class="mb-2"><strong>Driving License:</strong> <span th:text="${user.drivingLicenseNo} ?: 'N/A'"></span></p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="/user/update" enctype="multipart/form-data">
                        <input type="hidden" name="id" th:value="${user.id}" />

                        <div class="mb-3">
                            <label for="username" class="form-label">Username:</label>
                            <input type="text" class="form-control" id="username" name="username" th:value="${user.username}" required />
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" class="form-control" id="email" name="email" th:value="${user.email}" required />
                        </div>

                        <div class="mb-3">
                            <label for="phno" class="form-label">Phone:</label>
                            <input type="text" class="form-control" id="phno" name="phno" th:value="${user.phno}" required />
                        </div>

                        <div class="mb-3">
                            <label for="role" class="form-label">Role:</label>
                            <select class="form-select" id="role" name="role">
                                <option value="ROLE_USER" th:selected="${user.role.name() == 'ROLE_USER'}">USER</option>

                                <option sec:authorize="hasRole('ADMIN')"
                                        value="ROLE_ADMIN" th:selected="${user.role.name() == 'ROLE_ADMIN'}">ADMIN</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="drivingLicenseNo" class="form-label">Driving License No:</label>
                            <input type="text" class="form-control" id="drivingLicenseNo" name="drivingLicenseNo" th:value="${user.drivingLicenseNo}" required />
                        </div>

                        <div class="mb-3">
                            <label for="photoFile" class="form-label">Photo:</label>
                            <input type="file" class="form-control" id="photoFile" name="photoFile" accept="image/*" onchange="previewImage(event)" />
                            <div class="photo-preview mt-2">
                                <img id="photoPreview" th:src="${user.photo}" alt="Photo Preview"
                                     th:style="${user.photo != null ? 'display:block;' : 'display:none;'}" />
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Bookings -->
    <div class="card mx-auto" style="max-width: 1000px;">
        <div class="card-body">
            <h4 class="text-center text-primary mb-3">Recent Bookings</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-center">
                    <thead class="table-primary">
                    <tr>
                        <th scope="col">Car</th>
                        <th scope="col">Start Date</th>
                        <th scope="col">End Date</th>
                        <th scope="col">Amount Due</th>
                        <th scope="col">Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="booking : ${bookings}">
                        <td th:text="${booking.car.model}"></td>
                        <td th:text="${booking.startDate}"></td>
                        <td th:text="${booking.endDate}"></td>
                        <td th:text="'â‚¹' + ${booking.amountDue}"></td>
                        <td class="status"
                            th:classappend="${booking.paymentStatus == 'Paid' ? 'text-success bg-success bg-opacity-10' : 'text-danger bg-danger bg-opacity-10'}"
                            th:text="${booking.paymentStatus}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript for Image Preview -->
    <script>
        function previewImage(event) {
            const preview = document.getElementById('photoPreview');
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        }
    </script>
</div>
</body>
</html>